# https://github.com/almighty/almighty-jobs
- builder:
    name: bootstrap-duffy-node
    builders:
      - shell: |
          #!/bin/bash -e
          # Ensure we do not expose secrets
          set +x
          mkdir -p cicologs
          export CICO_API_KEY=$(cat ~/duffy.key)
          read CICO_hostname CICO_ssid <<< $(cico node get -f value -c ip_address -c comment)
          echo "CICO Hostname: $CICO_hostname, SSID: $CICO_ssid" | tee cicologs/bootstrap.log
          sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
          ssh_cmd="ssh $sshopts $CICO_hostname"
          export CICO_hostname CICO_ssid
          env | grep CICO > jenkins-env
          $ssh_cmd yum -y install {packages}

- builder:
    name: bootstrap-duffy-node-for-rpm-build
    builders:
      - bootstrap-duffy-node:
          packages: rpmdevtools rpm-build
      - copy-workspace-to-duffy-node:

- builder:
    name: bootstrap-duffy-node-for-acceptance-test
    builders:
      - bootstrap-duffy-node:
          packages: yum-utils

- builder:
    name: copy-workspace-to-duffy-node
    builders:
      - shell: |
          #!/bin/bash -e
          # Ensure we do not expose secrets
          set +x
          source jenkins-env
          sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
          ssh_cmd="ssh $sshopts $CICO_hostname"
          $ssh_cmd yum -y install rsync
          rsync -e "ssh $sshopts" -rlpt $(pwd)/ $CICO_hostname:workspace

- builder:
    name: build-srpm
    builders:
      - shell: |
          #!/bin/bash -e
          # Ensure we do not expose secrets
          set +x
          source jenkins-env
          sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
          ssh_cmd="ssh $sshopts $CICO_hostname"
          $ssh_cmd spectool -g -C workspace workspace/{specfile}
          $ssh_cmd rpmbuild --define '"_topdir /root"' --define '"_sourcedir workspace"' -bs workspace/{specfile}

- builder:
    name: get-srpm
    builders:
      - shell: |
          #!/bin/bash -e
          # Ensure we do not expose secrets
          set +x
          source jenkins-env
          sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
          rsync -e "ssh $sshopts" -rlpt $CICO_hostname:SRPMS/ $(pwd)

- builder:
    name: install-candidate-package
    builders:
      - shell: |
          #!/bin/bash -e
          # Ensure we do not expose secrets
          set +x
          source jenkins-env
          timeout=1200
          sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
          ssh_cmd="ssh $sshopts $CICO_hostname"
          release="pr${{ghprbPullId?No pull id}}job${{BUILD_NUMBER?No build number}}"
          echo -e "[{buildtag}-candidate]\nbaseurl=http://cbs.centos.org/repos/{buildtag}-candidate/\$basearch/os/\ngpgcheck=0" | $ssh_cmd tee /etc/yum.repos.d/{buildtag}-candidate.repo
          until [[ $($ssh_cmd repoquery --enablerepo={buildtag}-candidate --whatprovides "'{name}-pull-request-build-id(${{release}})'"|wc -l) -eq 1 ]]
          do
            if [[ $SECONDS -gt ${{timeout}} ]]
            then
                echo "Could not find the package after ${{SECONDS}}s"
                exit 1
            fi
            echo "Could not find {name}-pull-request-build-id(${{release}}) after ${{SECONDS}}s, retrying..."
            sleep 30
            $ssh_cmd yum clean all
          done
          $ssh_cmd yum install -y {name}-pull-request-build-id(${{release}})


- builder:
    name: free-duffy-node
    builders:
      - shell: |
          #!/bin/bash -e
          # Ensure we do not expose secrets
          set +x
          source jenkins-env
          export CICO_API_KEY
          cico node done $CICO_ssid
          exit $rtn_code
