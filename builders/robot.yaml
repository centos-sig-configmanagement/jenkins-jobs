- builder:
    name: puppet-acceptance-tests
    builders:
      - setup-virtualenv:
      - make-test-cico:

- builder:
    name: robotrpm
    builders:
      - shell: |
          #!/bin/bash -x
          export CICO_API_KEY=$(cat ~/duffy.key)
          export CICO_ENDPOINT=http://admin.ci.centos.org:8080/
          export BUILDTARGET={buildtarget}
          export BUILDTAG={buildtag}
          export SPECFILE={name}
          export PACKAGE={name}
          if [[ -n ${{ghprbPullId}} ]]; then
            export RELEASE=pr${{ghprbPullId}}job${{BUILD_NUMBER}}
          fi
          git clone https://github.com/centos-sig-configmanagement/puppet-acceptance-tests tests
          virtualenv venv
          source venv/bin/activate
          pip install --upgrade setuptools
          pip install -r tests/requirements.txt
          make -C tests {name} || true
          make -C tests rebot
